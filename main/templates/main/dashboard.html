{% extends "base.html" %}

{% block title %}Dashboard - Dog Rescue Management{% endblock %}

{% block extra_css %}
<style>
    .stats-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Total Dogs Box - Top Layer */
    .total-dogs-box {
        background: #2a2a2a;
        color: white;
        padding: 1.25rem;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 3;
        margin-bottom: 0.5rem;
    }

    .total-dogs-header {
        text-align: center;
        margin-bottom: 1rem;
    }

    .total-dogs-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.2s ease;
    }

    .total-dogs-number:hover {
        transform: translateY(-1px);
    }

    .total-dogs-label {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Icon styling - simple emojis with gradient */
    .icon-outline {
        display: inline-block;
        font-size: 1.8em;
        margin-right: 0.3rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        vertical-align: middle;
    }


    .charter-distribution {
        display: flex;
        align-items: center;
        gap: 1.25rem;
    }

    .charter-pie-chart {
        width: 120px;
        height: 120px;
        position: relative;
    }

    .charter-pie-chart svg {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    }

    .charter-legend {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .charter-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.3rem;
        border-radius: 6px;
        transition: background-color 0.2s ease;
        white-space: nowrap;
    }

    .charter-legend-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .charter-legend-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        border: 2px solid #1a1a1a;
        background-color: transparent;
        transition: all 0.3s ease;
    }

    .charter-legend-text {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .charter-legend-label {
        font-size: 0.75rem;
        font-weight: 500;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .charter-legend-value {
        font-size: 0.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    .charter-legend-percentage {
        font-size: 0.7rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-left: 0.3rem;
    }

    .charter-legend-text {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .charter-legend-label {
        font-size: 0.75rem;
        font-weight: 500;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .charter-legend-value {
        font-size: 0.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    /* Pie Charts Container */
    .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        position: relative;
        z-index: 2;
    }

    .chart-box {
        background: #2a2a2a;
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        color: white;
        will-change: transform, box-shadow;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .chart-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }


    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-container {
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
    }
    
    @media (max-width: 768px) {
        .charts-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .total-dogs-box {
            padding: 1rem;
        }

        .total-dogs-number {
            font-size: 2rem;
        }

        .charter-distribution {
            flex-direction: column;
            gap: 0.75rem;
            text-align: center;
        }

        .charter-pie-chart {
            width: 100px;
            height: 100px;
        }

        .chart-box {
            padding: 1.5rem;
        }

        .chart-container {
            flex-direction: column;
            gap: 1.5rem;
            min-height: auto;
        }

        .pie-chart {
            max-width: 200px;
            height: 200px;
        }

        .chart-legend {
            width: 100%;
        }
    }

    .charters-section {
        margin-top: 3rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .charter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .charter-card {
        background: #2a2a2a;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        color: white;
        will-change: transform, box-shadow;
        overflow: hidden;
        min-width: 0;
    }

    .charter-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .charter-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        min-width: 0;
        overflow: hidden;
    }

    .charter-name {
        font-size: 1.2rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
        white-space: normal;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .stat-label {
        font-size: 0.9rem;
        font-weight: 500;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .charter-charts {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        justify-content: center;
    }

    .charter-chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .charter-chart-title {
        font-size: 0.8rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
    }

    .charter-pie-chart-small {
        width: 60px;
        height: 60px;
        position: relative;
    }

    .dog-count-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        transition: all 0.2s ease;
        border: 1px solid rgba(102, 126, 234, 0.5);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .dog-count-badge:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        transform: translateY(-1px);
    }


    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    /* Tooltip styles */
    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    /* Permanent dark mode overrides for dashboard */
    .section-title {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }

    .stat-label {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }

    .charter-name,
    .charter-chart-title,
    .total-dogs-number,
    .total-dogs-label,
    .charter-distribution-label,



    /* Fix legend layout to prevent line breaks */
    .charter-legend-item .legend-label,
    .charter-legend-item .legend-percentage,
    .charter-legend-item .legend-count {
        flex-shrink: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

</style>
{% endblock %}

{% block content %}

<!-- Statistics -->
<div class="stats-container">
    <!-- Total Dogs Box - Top Layer -->
    <div class="total-dogs-box">
        <div class="total-dogs-header">
            <div class="total-dogs-number">{{ total_dogs }}</div>
            <div class="total-dogs-label">
                <span class="icon-outline">üêï</span>Total Dogs in Database
            </div>
        </div>
        
        <div class="charter-distribution">
            <div class="charter-pie-chart" id="charterPieChart">
                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                    <!-- Charter distribution pie chart will be generated by JavaScript -->
                </svg>
            </div>
            <div class="charter-legend" id="charterLegend">
                <!-- Charter legend will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Pie Charts Container -->
    <div class="charts-container">
        <!-- Health Status Box -->
        <div class="chart-box health-chart">
            <div class="total-dogs-header">
                <div class="total-dogs-label">
                    <span class="icon-outline">‚úö</span>Health Status Distribution
                </div>
            </div>
            
            <div class="charter-distribution">
                <div class="charter-pie-chart" id="healthPieChart">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                        <!-- Health status pie chart will be generated by JavaScript -->
                    </svg>
                </div>
                <div class="charter-legend" id="healthLegend">
                    <!-- Health legend will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Adoption Status Box -->
        <div class="chart-box adoption-chart">
            <div class="total-dogs-header">
                <div class="total-dogs-label">
                    <span class="icon-outline">üè†</span>Adoption Status Distribution
                </div>
            </div>
            
            <div class="charter-distribution">
                <div class="charter-pie-chart" id="adoptionPieChart">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                        <!-- Adoption status pie chart will be generated by JavaScript -->
                    </svg>
                </div>
                <div class="charter-legend" id="adoptionLegend">
                    <!-- Adoption legend will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Vaccination Status Box -->
        <div class="chart-box vaccination-chart">
            <div class="total-dogs-header">
                <div class="total-dogs-label">
                    <span class="icon-outline">üíâ</span>Vaccination Status Distribution
                </div>
            </div>
            
            <div class="charter-distribution">
                <div class="charter-pie-chart" id="vaccinationPieChart">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                        <!-- Vaccination status pie chart will be generated by JavaScript -->
                    </svg>
                </div>
                <div class="charter-legend" id="vaccinationLegend">
                    <!-- Vaccination legend will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charters Section -->
<div class="charters-section">
    <div class="section-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h2 class="section-title">Charters</h2>
            <a href="{% url 'records:charter_create' %}" class="btn" id="add-charter-btn" style="font-size: 1.2rem; font-weight: 700;">+</a>
        </div>
    </div>

    {% if charters %}
    <div class="charter-grid">
        {% for charter in charters %}
        <div class="charter-card" onclick="window.location.href='{% url 'records:charter_detail' charter.pk %}'">
            <div class="charter-header">
                <div>
                    <div class="charter-name">{{ charter.entity_info.name }}</div>
                </div>
                <span class="dog-count-badge">{{ charter.dog_count }} dog{{ charter.dog_count|pluralize }}</span>
            </div>
            
            <div class="charter-charts">
                <div class="charter-chart-container">
                    <div class="charter-chart-title">Health</div>
                    <div class="charter-pie-chart-small" id="charterHealthChart{{ charter.pk }}">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- Health pie chart will be generated by JavaScript -->
                        </svg>
                    </div>
                </div>
                <div class="charter-chart-container">
                    <div class="charter-chart-title">Adoption</div>
                    <div class="charter-pie-chart-small" id="charterAdoptionChart{{ charter.pk }}">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- Adoption pie chart will be generated by JavaScript -->
                        </svg>
                    </div>
                </div>
                <div class="charter-chart-container">
                    <div class="charter-chart-title">Vaccination</div>
                    <div class="charter-pie-chart-small" id="charterVaccinationChart{{ charter.pk }}">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <!-- Vaccination pie chart will be generated by JavaScript -->
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">üè¢</div>
            <h3>No charters yet</h3>
            <p>Create your first charter to get started with managing dogs and contacts.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Charter Distribution Data
    const charterColors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'];
    const charterData = [
        {% for charter in charters %}
        { 
            label: '{{ charter.entity_info.name }}', 
            value: {{ charter.dog_count }}, 
            color: charterColors[{{ forloop.counter0 }}] || '#6b7280'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Health Status Data
    const healthData = [
        { label: 'Healthy', value: {{ healthy_dogs }}, color: '#10b981' },
        { label: 'Sick', value: {{ sick_dogs }}, color: '#f59e0b' },
        { label: 'Passed Away', value: {{ passed_away_dogs }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ unspecified_health_dogs }}, color: '#6b7280' }
    ];

    // Adoption Status Data
    const adoptionData = [
        { label: 'Fit for Adoption', value: {{ fit_dogs }}, color: '#3b82f6' },
        { label: 'In Trial', value: {{ trial_dogs }}, color: '#f59e0b' },
        { label: 'Adopted', value: {{ adopted_dogs }}, color: '#10b981' },
        { label: 'Unfit for Adoption', value: {{ unfit_dogs }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ unspecified_dogs }}, color: '#6b7280' }
    ];

    // Vaccination Status Data
    const vaccinationData = [
        { label: 'Complete', value: {{ complete_vaccination_dogs }}, color: '#10b981' },
        { label: 'Incomplete', value: {{ incomplete_vaccination_dogs }}, color: '#f59e0b' },
        { label: 'Not Vaccinated', value: {{ not_vaccinated_dogs }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ unspecified_vaccination_dogs }}, color: '#6b7280' }
    ];

    // Function to create charter pie chart (without legend)
    function createCharterPieChart(containerId, data) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const svg = container.querySelector('svg');
        if (!svg) return;

        // Clear existing content
        svg.innerHTML = '';
        
        // Add gradient definition
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'purpleGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y2', '100%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', '#667eea');
        
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', '#764ba2');
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        const total = data.reduce((sum, item) => sum + item.value, 0);
        if (total === 0) return;


        let cumulativePercentage = 0;

        data.forEach(item => {
            if (item.value === 0) return;

            const percentage = (item.value / total) * 100;
            const startAngle = (cumulativePercentage / 100) * 360;
            const endAngle = ((cumulativePercentage + percentage) / 100) * 360;

            const startAngleRad = (startAngle - 90) * (Math.PI / 180);
            const endAngleRad = (endAngle - 90) * (Math.PI / 180);

            const centerX = 50;
            const centerY = 50;
            const radius = 45;

            const x1 = centerX + radius * Math.cos(startAngleRad);
            const y1 = centerY + radius * Math.sin(startAngleRad);
            const x2 = centerX + radius * Math.cos(endAngleRad);
            const y2 = centerY + radius * Math.sin(endAngleRad);

            const largeArcFlag = percentage > 50 ? 1 : 0;

            const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    path.setAttribute('fill', 'transparent');
                    path.setAttribute('stroke', 'url(#purpleGradient)');
                    path.setAttribute('stroke-width', '1');
                    path.style.transition = 'all 0.3s ease';
                    path.dataset.originalColor = item.color;

                    svg.appendChild(path);

            cumulativePercentage += percentage;
        });
    }

    // Function to create pie chart
    function createPieChart(containerId, legendId, data) {
        const total = data.reduce((sum, item) => sum + item.value, 0);
        if (total === 0) return;

        const svg = document.querySelector(`#${containerId} svg`);
        const legend = document.getElementById(legendId);
        
        // Clear existing content
        svg.innerHTML = '';
        legend.innerHTML = '';
        
        // Add gradient definition
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'purpleGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y2', '100%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', '#667eea');
        
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', '#764ba2');
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        let cumulativePercentage = 0;
        const radius = 40;
        const centerX = 50;
        const centerY = 50;

        data.forEach((item, index) => {
            if (item.value === 0) return;

            const percentage = (item.value / total) * 100;
            const startAngle = (cumulativePercentage / 100) * 360;
            const endAngle = ((cumulativePercentage + percentage) / 100) * 360;

            // Create path for pie slice
            const startAngleRad = (startAngle - 90) * Math.PI / 180;
            const endAngleRad = (endAngle - 90) * Math.PI / 180;

            const x1 = centerX + radius * Math.cos(startAngleRad);
            const y1 = centerY + radius * Math.sin(startAngleRad);
            const x2 = centerX + radius * Math.cos(endAngleRad);
            const y2 = centerY + radius * Math.sin(endAngleRad);

            const largeArcFlag = percentage > 50 ? 1 : 0;

            const pathData = [
                `M ${centerX} ${centerY}`,
                `L ${x1} ${y1}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                'Z'
            ].join(' ');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('fill', 'transparent');
            path.setAttribute('stroke', 'url(#purpleGradient)');
            path.setAttribute('stroke-width', '1');
            path.style.cursor = 'pointer';
            path.style.transition = 'all 0.3s ease';
            path.dataset.originalColor = item.color;

            svg.appendChild(path);

            // Create legend item
            const legendItem = document.createElement('div');
            legendItem.className = 'charter-legend-item';
            legendItem.innerHTML = `
                <div class="charter-legend-color" style="background-color: ${item.color}; border: 2px solid #1a1a1a;" data-original-color="${item.color}"></div>
                <div class="charter-legend-text">
                    <span class="charter-legend-label">${item.label}</span>
                    <span class="charter-legend-value">
                        ${item.value}
                        <span class="charter-legend-percentage">(${percentage.toFixed(1)}%)</span>
                    </span>
                </div>
            `;
            
            const colorCircle = legendItem.querySelector('.charter-legend-color');
            const originalColor = colorCircle.dataset.originalColor;
            
            legend.appendChild(legendItem);

            // Cross-hover functionality: hover over pie segment highlights legend, and vice versa
            const highlightBoth = () => {
                // Highlight pie segment
                path.setAttribute('fill', originalColor);
                path.style.transform = 'scale(1.05)';
                path.style.transformOrigin = 'center';
                
                // Legend stays colored (already colored by default)
                colorCircle.style.borderColor = originalColor;
            };

            const unhighlightBoth = () => {
                // Unhighlight pie segment
                path.setAttribute('fill', 'transparent');
                path.style.transform = 'scale(1)';
                
                // Legend stays colored, just reset border
                colorCircle.style.borderColor = '#1a1a1a';
            };

            // Add hover effects to pie segment
            path.addEventListener('mouseenter', highlightBoth);
            path.addEventListener('mouseleave', unhighlightBoth);

            // Add hover effects to legend item
            legendItem.addEventListener('mouseenter', highlightBoth);
            legendItem.addEventListener('mouseleave', unhighlightBoth);

            cumulativePercentage += percentage;
        });
    }

    // Create all pie charts
    createPieChart('charterPieChart', 'charterLegend', charterData);
    createPieChart('healthPieChart', 'healthLegend', healthData);
    createPieChart('adoptionPieChart', 'adoptionLegend', adoptionData);
    createPieChart('vaccinationPieChart', 'vaccinationLegend', vaccinationData);

    // Create charter-specific pie charts
    {% for charter in charters %}
    // Health chart for {{ charter.entity_info.name }}
    const charterHealthData{{ charter.pk }} = [
        { label: 'Healthy', value: {{ charter.healthy_count|default:0 }}, color: '#10b981' },
        { label: 'Sick', value: {{ charter.sick_count|default:0 }}, color: '#f59e0b' },
        { label: 'Passed Away', value: {{ charter.passed_away_count|default:0 }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ charter.unspecified_health_count|default:0 }}, color: '#6b7280' }
    ];

    // Adoption chart for {{ charter.entity_info.name }}
    const charterAdoptionData{{ charter.pk }} = [
        { label: 'Fit', value: {{ charter.fit_count }}, color: '#3b82f6' },
        { label: 'Trial', value: {{ charter.trial_count }}, color: '#f59e0b' },
        { label: 'Adopted', value: {{ charter.adopted_count }}, color: '#10b981' },
        { label: 'Unfit', value: {{ charter.unfit_count }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ charter.unspecified_count }}, color: '#6b7280' }
    ];

    // Vaccination chart for {{ charter.entity_info.name }}
    const charterVaccinationData{{ charter.pk }} = [
        { label: 'Complete', value: {{ charter.complete_vaccination_count|default:0 }}, color: '#10b981' },
        { label: 'Incomplete', value: {{ charter.incomplete_vaccination_count|default:0 }}, color: '#f59e0b' },
        { label: 'Not Vaccinated', value: {{ charter.not_vaccinated_count|default:0 }}, color: '#ef4444' },
        { label: 'Unspecified', value: {{ charter.unspecified_vaccination_count|default:0 }}, color: '#6b7280' }
    ];

    // Create charter charts without legends
    createCharterPieChart('charterHealthChart{{ charter.pk }}', charterHealthData{{ charter.pk }});
            createCharterPieChart('charterAdoptionChart{{ charter.pk }}', charterAdoptionData{{ charter.pk }});
            createCharterPieChart('charterVaccinationChart{{ charter.pk }}', charterVaccinationData{{ charter.pk }});
            {% endfor %}
        });

        // Add charter container hover effects
        document.addEventListener('DOMContentLoaded', function() {
            const charterCards = document.querySelectorAll('.charter-card');
            
            charterCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    // Find all pie chart paths within this charter card
                    const piePaths = this.querySelectorAll('svg path[data-original-color]');
                    piePaths.forEach(path => {
                        path.setAttribute('fill', path.dataset.originalColor);
                    });
                });
                
                card.addEventListener('mouseleave', function() {
                    // Reset all pie chart paths to transparent
                    const piePaths = this.querySelectorAll('svg path[data-original-color]');
                    piePaths.forEach(path => {
                        path.setAttribute('fill', 'transparent');
                    });
                });
            });
        });



        // Add loading states to charts
        function showChartLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.add('loading-state');
            }
        }

        function hideChartLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.classList.remove('loading-state');
            }
        }

        // Page is now permanently in dark mode - no toggle needed
</script>
{% endblock %}